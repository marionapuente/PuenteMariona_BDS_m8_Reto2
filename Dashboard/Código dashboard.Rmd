---
title: "Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(shiny)
library(dplyr)
library(ggplot2)
library(viridis)
```

```{r}
datos <- read.csv('Base de datos depurada.csv')
datos <- select(datos, -idno)
```

## Column {data-width="300"}

### Opciones

```{r}
selectInput("cntry_levels", "Países:", choices = unique(datos$cntry), multiple = TRUE)
selectInput("gndr_levels", "Género:", choices = unique(datos$gndr), multiple = TRUE)
selectInput("age_levels", "Edad:", choices = unique(datos$age_category), multiple = TRUE)
```

## Column {data-width="700"}

### Mapa de calor

```{r}
plotOutput("heatmap")
```

```{r}
shinyServer(function(input, output) {
  output$heatmap <- renderPlot({
    selected_cntry <- input$cntry_levels
    selected_gndr <- input$gndr_levels
    selected_age <- input$age_levels
    
    data <- datos %>%
      filter(cntry %in% selected_cntry,
             gndr %in% selected_gndr,
             age_category %in% selected_age) %>%
      filter(!is.na(atchctr) & !is.na(atcherp) & !is.na(cntry) & !is.na(gndr) & !is.na(age_category)) %>%
      select(atchctr, atcherp, cntry, gndr, age_category)
    
    # Debugging: Print the filtered data to console
    print(head(data))
    
    if (nrow(data) > 0) {
      ggplot(data, aes(x = atchctr, y = atcherp, color = gndr)) +
        geom_bin2d(bins = 20) +
        scale_fill_viridis_c() +
        labs(x = "Attached country", y = "Attached Europe", title = "Mapa de calor") +
        theme_minimal()
    } else {
      ggplot() +
        labs(title = "No data available for the selected filters")
    }
  })
})
```
